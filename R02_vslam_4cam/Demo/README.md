# 実行方法
本体の実行ファイルはDemo/kakip_vslam_demoです．
このプログラムは相対パスDemo/settings.yamlを参照するので，プロジェクトのルートディレクトリから実行してください．
もしくはscript/run_demo.shを実行してください．

# 動作の流れ
まずDemo/settings.yamlを参照し，接続先のサーバ，カメラの台数と各カメラの設定，ORB_SLAM2のパラメータなどを取得します．
各カメラについて，内部パラメータが記述されていない場合（fxがないか，0の場合），Demo/camera{i}_settings.yamlを参照します．ここでiにはDemo/settings.yamlのCamerasに記述された順に応じて1-4の値が入ります．
以上の過程で内部パラメータが見つからない場合，キャリブレーションに入ります．キャリブレーション中はRaspberryPiに当該カメラの画像を送信します．Demo/settings.yamlのChessboardの項に記述されているチェスボードを当該カメラに提示してください．十分なサンプルが集まると，自動的にキャリブレーションが完了します．その際，結果をDemo/camera{i}_settings.yamlに保存します．
全てのカメラについて内部パラメータが見つかるまでキャリブレーションを繰り返します．

次にVisual SLAMへ移行します．まず特徴量のマッチングのために必要なVocabulary/ORBvoc.txtを読み込みます．大きなファイルのため，読み込みには数十秒かかります．
その後，カメラからの画像の取得とSLAMの処理が開始されます．大まかな流れは次の通りです．

- 未初期化状態（NOT_INITIALIZED）：まだマップがない状態で，マップを初期化するためのフレームが得られるのを待っている状態
- トラッキング状態（OK，LOST）：マップとカメラ画像から自己位置を推定したり，カメラ画像の特徴点を新たにマップに追加したりする状態

トラッキング状態に移行した直後の，マップが小さい状態でLOST状態になると，マップの初期化に失敗したと判断し，未初期化状態に戻ります．
一度十分な大きさのマップができた後はプログラムが終了するまでトラッキング状態となります．

# マップの初期化について
マップの初期化には，同じ特徴点を共有する二つのフレームが必要です．
これらを初期化フレームA，初期化フレームBとします．上記の実初期化状態は，さらに次の二つの状態に分けられます．
1. 初期化フレームAを待っている状態
1. 初期化フレームBを待っている状態

1では，現在の（直近でカメラから得られた）フレームに十分な特徴点が含まれていれば，それを初期化フレームAとして，2に移行します．
2では，現在のフレームに初期化フレームAとマッチする特徴点が十分に含まれていればこれを初期化フレームBとしてマップの初期化を行い，トラッキング状態に移行します．そうでなければ，初期化フレームAを破棄して1に移行します．

本プログラムでは，異なる方向を向いた複数台のカメラを想定しているため，異なる2台のカメラで直ちに特徴量がマッチすることは想定されません．
したがって，あるカメラからのフレームを初期化フレームAとした直後に，別のカメラからのフレームが得られると，マッチングに失敗することにより，初期化フレームAが破棄されるということが頻繁に起こり得ます．
これを防ぐため，2に移行して最初の1秒間は，初期フレームAとは異なるカメラから得られたフレームは無視するようになっています．

以上を踏まえると，多くの場合，マップの初期化は始めに十分な特徴点を得た一台のカメラによって行われることになります．その際，初期化フレームAのカメラ姿勢がマップの原点となります．このため，出来上がるマップの向きはプログラム実行毎に異なることになります．
