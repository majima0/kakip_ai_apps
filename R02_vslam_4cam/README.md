# YOLO-Planar-SLAM

# インストール
1. ディレクトリyolo-planar-slamをKakipの適当なディレクトリ（以下，ホームディレクトリとする）にコピーする．
2. KakipにNode.jsと必要なパッケージをインストールする．
```
sudo apt install nodejs npm
sudo npm install -g express socket.io@2.0.4 ejs
```
3. KakipにPCLをインストールする．
```
sudo apt install libpcl-dev
```

# カメラの設定
カメラの設定は
`~/yolo-planar-slam/Demo/settings.yaml`（以下，`settings.yaml`と記述）
のCameras以下に記述する．
Camerasは連想配列の配列になっており，各連想配列がカメラ一台に対応する．
連想配列の数を1-4の間で増減させることでカメラの台数を設定することができる．連想配列に必要な項目は以下の通り．
- device (文字列または整数): OpenCVのVideoCaptureに渡す入力ソース．Kakipに接続されているカメラに応じて適切に設定する．
- pose (opencv-matrix): 台座に対するカメラの姿勢を4x4の行列として設定する．行列は3次元の同次座標変換で，左からかけることで台座の座標系からカメラの座標系へ変換する．カメラの座標系はxが右，yが下，zが前方の右手系．記述例を以下に示す．

この他，キャリブレーション済みのカメラの場合は，カメラパラメータを連想配列の要素として記述することもできる．カメラパラメータについては後述する．

## poseの記述例
poseはOpenCVの行列であるため，`!!opencv-matrix`を付与した連想配列として記述する．
例えば，float型の行列
```
[a b c d]
[e f g h]
[i j k l]
[m n o p]
```
は以下のように記述する．
```
pose: !!opencv-matrix
  rows: 4
  cols: 4
  dt: f
  data: [a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p]
```
行列poseの第1列（上記のa,e,i,mに対応）は，台座のx軸の方向をカメラ座標系で表した方向ベクトル（最後が0の同次ベクトル）である．例えば，台座のx軸を向いたカメラのposeは，
第1列が[0.0, 0.0, 1.0, 0.0]（前方であるz軸）を縦に並べたベクトルとなる．
一方，台座のx軸がカメラの右方向に対応する場合，第1列は[1.0, 0.0, 0.0, 0.0]を縦に並べたものとなる．
同様に，第2列と第3列はそれぞれ台座のy軸とz軸をカメラ座標系で表した方向ベクトルとなる．
第4列（上記のd,h,l,p）は台座の原点をカメラ座標系で表した位置ベクトル（最後が1の同次ベクトル）である．
例えば，台座の原点がカメラから見て後方1cmにある場合，第4列は[0.0, 0.0, -0.01, 1.0]を縦に並べたものとなる．

例としてカメラ4台が固定された台車を考える．
台車の座標系は任意に設定できるが，簡単のためカメラと同様に右方向をx軸，下方向をy軸，前方をz軸とする．
台車の中心を原点とし，中心から前方に10cmの点にカメラ0を前向きに設置する．同様に中心から右に20cmの点にカメラ1を右向き，後方に30cmの点にカメラ2を後ろ向き，左に40cmの点にカメラ3を左向きに設置する．
カメラ0，カメラ1，カメラ2，カメラ3はそれぞれ/dev/video0, /dev/video1, /dev/video2, /dev/video3として認識されている．
このような状況では以下のような記述となる．
```
Cameras:
  - device: "/dev/video0"
    pose: !!opencv-matrix
      rows: 4
      cols: 4
      dt: f
      data: [ 1., 0., 0., 0.,
              0., 1., 0., 0.,
              0., 0., 1.,-0.1,
              0., 0., 0., 1.]
  - device: "/dev/video1"
    pose: !!opencv-matrix
      rows: 4
      cols: 4
      dt: f
      data: [ 0., 0.,-1., 0.,
              0., 1., 0., 0.,
              1., 0., 0.,-0.2,
              0., 0., 0., 1.]
  - device: "/dev/video2"
    pose: !!opencv-matrix
      rows: 4
      cols: 4
      dt: f
      data: [-1., 0., 0., 0.,
              0., 1., 0., 0.,
              0., 0.,-1.,-0.3,
              0., 0., 0., 1.]
  - device: "/dev/video3"
    pose: !!opencv-matrix
      rows: 4
      cols: 4
      dt: f
      data: [ 0., 0., 1., 0.,
              0., 1., 0., 0.,
             -1., 0., 0.,-0.4,
              0., 0., 0., 1.]
```

# サーバの設定
VSLAMやキャリブレーションの状態を他プロセスからTCPソケット経由で確認することができる．
接続先のサーバは`settings.yaml`のServerに連想配列として指定する．下記の例のように，アドレスを文字列address，ポート番号を整数portに指定する．
```
Server:
  address: 192.168.1.100
  port: 2000
```

サーバ側の処理例は同梱の`test_server.py`を参照．

# カメラのキャリブレーション
## 実行条件
カメラパラメータ（内部パラメータ）は焦点距離（fx, fy），光学中心（cx, cy），レンズの歪み係数（k1, k2, k3, etc.）からなり，設定ファイルに予め指定するか，キャリブレーションを行って推定する．
以下の二通りの指定方法がある．
1. `settings.yaml`のCamerasの各連想配列の要素として記述する．
2. `camera{i}_settings.yaml`に記述して`~/yolo-planar-slam/Demo`以下に配置する．

上記の`{i}`には，`settings.yaml`で記述された順に1-4が入る．
プログラム起動時に各カメラについて1, 2の順に探索され，両者とも見つからないカメラについては順次キャリブレーションが実行される．
キャリブレーションが完了したカメラについては，2の方法で結果が保存される．
キャリブレーションをやり直したい場合は，`camera{i}_settings.yaml`を削除してプログラムを再び起動する．

## 設定
キャリブレーションはチェッカーパターンを撮影することによって行われる．用意したチェッカーパターンを`settings.yaml`のChessboardに記述する必要がある．
チェッカーパターンの交差点の数が9x6，間隔が2.5cmの場合，以下のように記述する．
```
Chessboard:
  cols: 9
  rows: 6
  cellSize: 0.025
```

キャリブレーションのパラメータについては`settings.yaml`のCalibrationに記述する．
パターンを撮影する回数はnumSamplesに指定する．
映像の遅れが大きい場合はframeSkipsを1以上とする．
光学中心を推定せずに画像の中心に固定する場合は，fixPrincipalPointをtrueとする．

## 手順
キャリブレーションの手順は以下の通りとなる．
1. ディスプレイを接続したKakip，またはKakipとネットワークで繋がった別の端末（以下サーバとする）で同梱の`test_server.py`を実行する．
```
python3 test_server.py
```
2. Kakipで本プログラムを実行する．
```
cd ~/yolo-planar-slam
sudo script/run_vslam.sh
```
3. キャリブレーションが必要なカメラの映像がサーバのディスプレイに表示される．
4. 対象のカメラにチェッカーパターンを呈示する．全ての交差点の位置が取得できると左上のカウントが増加するので，上記のnumSamplesに達するまで様々な距離や角度で呈示し続ける．
5. 撮影回数に達するとカメラパラメータが推定される．他にキャリブレーションが必要なカメラがあれば3に戻って実行される．無ければVSLAMが開始する．

# VSLAMの実行
キャリブレーションが完了していれば，キャリブレーションと同様の方法でVSLAMが開始される．
VSLAMの状態をブラウザから確認するためには，
上記の2の前に，Kakip上の別のターミナルで
```
script/run_viewer.sh
```
を実行しておく．ブラウザで
```
http://{KakipのIPアドレス}:3001/
```
にアクセスすると，ブラウザ上でVSLAMの状態が可視化される．